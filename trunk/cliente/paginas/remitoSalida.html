<div class="row span8" id="remitoForm">
	<div data-bind="visible: $root.mostrarSuccess" class="alert alert-success">
		<span data-bind="text: $root.successMensaje"></span>
	</div>
	<div data-bind="visible: $root.mostrarError" class="alert alert-error">
		<span data-bind="text: $root.errorMensaje"></span>
	</div>		
	<div data-bind="visible: $root.mostrarForm">
		<div class="span8 well">
			<h4>Remito de Salida</h4>
			<hr>
			<div class="row">
				<div class="control-group">
					<label class="control-label span1" for="selectEmpresa">Se&ntilde;or(es):</label>
					<span class="span5" id="inputPersona" data-bind="text: remito().persona.nombre"></span>
					<span class="span5" id="inputEmpresa" data-bind="text: remito().empresa.razonSocial"></span>
				</div>		
			</div>
			<div class="row">
				<label class="control-label span2" for="inputApellido">Domicilio:</label>
				<span class="span5" id="inputApellido" data-bind="text: remito().deposito.domicilio"></span>
			</div>
			<div class="row">
				<label class="control-label span2" for="inputCalle">Departamento:</label>
				<span class="span2" id="inputCalle" data-bind="text: remito().deposito.departamento"></span>
				<label class="control-label span2" for="inputCUIT">N&uacute;mero de CUIT :</label>
				<span class="span2" id="inputCUIT" data-bind="text: remito().empresa.cuit"></span>
			</div>
			<div class="row">
				<label class="control-label span2" for="inputIVA">Condici&oacute;n de IVA:</label>
				<span class="span5" id="inputIVA" data-bind="text: remito().empresa.iva"></span>
			</div>
			<div class="row">
				<label class="control-label span2" for="selectChofer">Chofer:</label>
			</div>
			<hr>
			<div class="row span8">
				<label class="control-label" for="inputTipo">Condici&oacute;n de Venta:</label>
				<span id="inputTipo" data-bind="">Contado</span>
				<label class="control-label" for="inputTipo">Factura N&uacute;mero:</label>
				<span id="inputTipo" data-bind="">0001-12345678</span>
			</div>
		</div>
		<div class="span8 well">
			<table class="table table-striped table-bordered">
				<thead>
					<tr>
						<th>Codigo</th><th>Cantidad</th><th>Descripcion</th>
					</tr>
				</thead>
				<tbody data-bind="foreach: remito().productos">
					<tr>
						<td data-bind="text: codigo"></td>
						<td><input type="text" id="inputCantidad" class="input-large" style="width:150px;" data-bind="value: cantidad"></td>
						<td data-bind="text: descripcion"></td>
					</tr>
				</tbody>
			</table>
			<button id="generar" class="btn btn-primary" data-bind="click: generar">Generar Remito de Salida</button>
			<button id="cancelar" class="btn" data-bind="click: cancelar">Cancelar</button>
		</div>
	</div>
</div>
<script language="javascript">
	function lineaRemito() {
		var self = this;
		
		self.codigo = ko.observable();
		self.cantidad = ko.observable();
		self.descripcion = ko.observable();
	}
	
	function Remito() {
		var self = this;
		
		self.deposito = ko.observable();
		self.empresa = ko.observable();
		self.persona = ko.observable();
		self.chofer = ko.observable();
		self.fecha = ko.observable();
		self.lineaRemitos = ko.observableArray();
	}
	
	function RemitoModelo() {
		var self = this;
		
		self.title = ko.observable("Administrar Remito");
		self.mostrarForm = ko.observable(true);
		self.mostrarSuccess = ko.observable(false);
		self.successMensaje = ko.observable("");
		self.mostrarError = ko.observable(false);
		self.errorMensaje = ko.observable("");
		self.mostrarFormError = ko.observable(false);
		self.formErrorMensaje = ko.observable("");
				
		self.nuevaLinea = ko.observable(new lineaRemito());
		self.codigos = ko.observableArray();
		self.codigoSeleccionado = ko.observable(null);
		self.empresas = ko.observableArray();
		self.personas = ko.observableArray();
		self.choferes = ko.observableArray();
		self.remito = ko.validatedObservable(new Remito());
		
		self.volver = function() {
			window.location.href = "./Index.html";
		};
		
		self.cargar = function() {
			var exito = function(data) {
				if(data.status != "OK") {
				} else {
					self.remito(data.data);
				}
			};
			var falla = function(data) {
			};
			getData("./servidor/sterilav.php?op=getRemito&id=" + amplify.store.sessionStorage("sterilav.remitoEditado"),exito,falla);
		};
		
		self.cargaEmpresas = function() {
			var exitoEmpresa = function(empresas) {
				if(empresas.status != "OK") {
				} else {
					for(var i=0; i< empresas.data.length; i++) {
						self.empresas().push(empresas.data[i]);
					}
				}
			};
			var fallaEmpresa = function(data) {
			};
			getDataSync("./servidor/sterilav.php?op=listaEmpresas",exitoEmpresa,fallaEmpresa);
		};
		self.cargaChoferes = function() {
			var exitoChofer = function(choferes) {
				if(choferes.status != "OK") {
				} else {
					for(var i=0; i< choferes.data.length; i++) {
						self.choferes().push(choferes.data[i]);
					}
				}
			};
			var fallaChofer = function(data) {
			};
			getDataSync("./servidor/sterilav.php?op=listaChoferes",exitoChofer,fallaChofer);
		};
		self.cargaProductos = function() {
			var exitoProducto = function(productos) {
				if(productos.status != "OK") {
				} else {
					for(var i=0; i< productos.data.length; i++) {
						self.codigos().push({id:productos.data[i].id, descripcion:productos.data[i].descripcion});
					}
				}
			};
			var fallaProducto = function(data) {
			};
			getDataSync("./servidor/sterilav.php?op=listaProductos",exitoProducto,fallaProducto);
		};
		self.cargaPersonas = function() {
			var exitoPersona = function(personas) {
				if(personas.status != "OK") {
				} else {
					for(var i=0; i< personas.data.length; i++) {
						self.personas().push(personas.data[i]);
					}
				}
			};
			var fallaPersona = function(data) {
			};
			getDataSync("./servidor/sterilav.php?op=listaUsuariosParaRemito",exitoPersona,fallaPersona);
		};
		
		self.generar = function() {
			var exito = function(data) {
				if(data.status != "OK") {
					$("#errorMsg").show();
					$("#errorMsg").append(data.data);
				} else {
					self.mostrarForm(false);
					self.successMensaje("El Remito de Salida se ha generado.");
					self.mostrarSuccess(true);
					amplify.store.sessionStorage("sterilav.remitoEditado", null);
				}
			};
			var falla = function(data) {
				if(data.data) {
					self.formErrorMensaje(data.data);
				} else {
					self.formErrorMensaje("Hubo un error tratando de generar el Remito de Salida.");
				}
				self.mostrarFormError(true);				
			};
			var url = "./servidor/sterilav.php?op=updateRemito";
			postData(url,exito,falla,JSON.parse(ko.toJSON(self.remito())));
		};
		self.cancelar = function() {
			amplify.store.sessionStorage("sterilav.remitoEditado", null);
			window.location.href = "./Index.html";
		};
		
		self.cargaPersonas();
		self.cargaEmpresas();
		self.cargaProductos();
		self.cargaChoferes();
		self.cargar();
	}

	var remitoModelo = new RemitoModelo();
	ko.applyBindings(remitoModelo, document.getElementById("remitoForm"));  
</script>