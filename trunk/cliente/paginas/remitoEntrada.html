<div class="row span8" id="remitoForm" data-bind="with: remito">
	<div class="print">		
	<div>
		<div class="span8 well" data-bind="visible: $root.mostrarForm">
			<h4>Remito Numero: <span data-bind="text: id"></span></h4>
			<hr>
			<table width="100%">
				<tr>
					<td><label class="span2 label" for="selectEmpresa">Fecha:</label></td>
					<td><input class="input-small uneditable-input" readonly="" id="inputFecha" data-bind="value: fecha" /></td>
					<!-- ko if: (tipo()=='1') -->
						<td><label class="span2 label">Hora Retiro:</label></td>
						<td><input class="input-small" data-bind="value: horaRetiro" /></td>
					<!-- /ko -->
					<!-- ko if: (tipo()=='3') -->
						<td><label class="span2 label">Hora Entrega:</label></td>
						<td><input class="input-small" data-bind="value: horaEntrega" /></td>
					<!-- /ko -->
				</tr>
				<tr>
					<td><label class="span2 label" for="selectEmpresa">Cliente:</label></td>
					<td>
						<input class="span3 uneditable-input" readonly="" id="inputPersona" data-bind="value: persona().nombre" />
					</td>
					<td>
						<!-- ko ifnot: $root.editando() -->
							<select id="selectEmpresa" data-bind="options: $root.empresas, optionsText: 'razonSocial', value: empresa" class="span2"></select>
						<!-- /ko -->
						<!-- ko if: $root.editando() -->
							<input class="span2 uneditable-input" readonly="" id="inputEmpresa" data-bind="value: empresa().razonSocial" />
						<!-- /ko -->
					</td>
					<td>
						<!-- ko ifnot: $root.editando() -->
							<select id="selectDeposito" data-bind="options: empresa().depositos, optionsText: 'nombre', value: deposito" class="span2"></select>
						<!-- /ko -->
						<!-- ko if: $root.editando() -->
							<input class="span2 uneditable-input" readonly="" id="inputDeposito" data-bind="value: deposito().nombre" />
						<!-- /ko -->
					</td>
				</tr>
				<tr>
					<td><label class="span2 label" for="inputApellido">Domicilio:</label></td>
					<td colspan="3"><input class="span6 uneditable-input" readonly="" id="inputApellido" data-bind="value: deposito().domicilio"></input></td>
				</tr>
				<tr>
					<td><label class="span2 label" for="inputCalle">Departamento:</label></td>
					<td><input class="span3 uneditable-input" readonly="" id="inputCalle" data-bind="value: deposito().departamento"></input></td>
					<td><label class="span2 label" for="inputCUIT">N&uacute;mero de CUIT :</label></td>
					<td><input class="input-medium uneditable-input" readonly="" id="inputCUIT" data-bind="value: empresa().cuit"></input></td>
				</tr>
				<tr>
					<td><label class="span2 label" for="inputIVA">Condici&oacute;n de IVA:</label></td>
					<td><input class="span3 uneditable-input" readonly="" id="inputIVA" data-bind="value: empresa().iva"></input></td>
					<td><label class="span2 label" for="selectChofer">Chofer:</label></td>
					<td>
						<!-- ko ifnot: $root.editando() -->
							<select id="selectChofer" data-bind="options: $root.choferes, optionsText: 'nombre', value: chofer" class="span2"></select>
						<!-- /ko -->
						<!-- ko if: $root.editando() -->
							<input class="span2 uneditable-input" readonly="" id="inputChofer" data-bind="value: chofer().nombre" />
						<!-- /ko -->
					</td>
				</tr>
				<tr>
					<td><label class=" span2 label" for="selectvehiculo">Vehiculo:</label></td>
					<td>
						<!-- ko ifnot: $root.editando() -->
							<select id="selectVehiculo" data-bind="options: $root.vehiculos, optionsText: 'patente', value: vehiculo"></select>
						<!-- /ko -->
						<!-- ko if: $root.editando() -->
							<input class="span2 uneditable-input" readonly="" id="inputVehiculo" data-bind="value: vehiculo().patente" />
						<!-- /ko -->
					</td>
				</tr>
				<tr>
					<td><label class="span2 label" for="inputDetalle">Observaciones:</label></td>
					<td colspan="3"><textarea id="inputDetalle" data-bind="value:observaciones" class="span6" /></textarea></td>
				</tr>
			</table>
		</div>
		<div class="span8">
			<div data-bind="visible: $root.mostrarSuccess" class="alert alert-success">
				<span data-bind="text: $root.successMensaje"></span>
			</div>
			<div data-bind="visible: $root.mostrarError" class="alert alert-error">
				<span data-bind="text: $root.errorMensaje"></span>
			</div>
		</div>
		<div class="span8 well" data-bind="visible: $root.mostrarForm">										
			<table class="span6">
				<thead>
					<tr>
						<th>Codigo</th>
						<th>Entrega</th>
						<th>Retira</th>
						<th>Descripcion</th>
					</tr>
				</thead>
				<tbody class="table table-condensed">
					<tr>
						<td><select rel="noprint" type="text" id="inputCodigo" data-bind="visible: $parent.productos().length > 0, options: $parent.productos, optionsText: 'codigo', value: $parent.codigoSeleccionado" class="input-medium"></select></td>
						<td><input rel="noprint" type="text" id="inputEntrega" class="input-small" data-bind="visible: $parent.productos().length > 0"></td>
						<td><input rel="noprint" type="text" id="inputRetira" class="input-small" data-bind="visible: $parent.productos().length > 0"></td>
						<td><input rel="noprint" type="text" id="inputDescripcion" data-bind="visible: $parent.productos().length > 0, value: $parent.codigoSeleccionado() ? $parent.codigoSeleccionado().descripcion : ''" class="input-medium" disabled></td>
						<td><input type="button" rel="noprint" id="registro" class="btn" data-bind="visible: $parent.productos().length > 0, click: $parent.agregar" value="Agregar" /></td>
					</tr>
				</tbody>
				<tbody data-bind="visible: lineaRemitos().length == 0">
					<tr class="alert alert-info"><td colspan="5">El Remito no tiene productos.</td></tr>
				</tbody>				
				<tbody class="table table-striped table-bordered" data-bind="foreach: lineaRemitos, visible: lineaRemitos().length > 0">
					<tr>
						<td>
							<span data-bind="text: codigo, attr: {id: 'showCodigo' + $data.codigo()}"></span>
						</td>
						<td>
							<input data-bind="value: entrega, attr: {id: 'editEntrega' + $data.codigo()}" style="display:none;" class="input-medium">
							<span data-bind="text: entrega, attr: {id: 'showEntrega' + $data.codigo()}"></span>
						</td>
						<td>
							<input data-bind="value: retira, attr: {id: 'editRetira' + $data.codigo()}" style="display:none;" class="input-medium">
							<span data-bind="text: retira, attr: {id: 'showRetira' + $data.codigo()}"></span>
						</td>
						<td data-bind="text: descripcion"></td>
						<td>
							<a href="#" data-bind="click: $root.editar, attr: {id: 'editProd' + $data.codigo()}"><i class="icon-edit"></i></a> 
							<a href="#" data-bind="click: $root.borrar, attr: {id: 'delProd' + $data.codigo()}"><i class="icon-remove"></i></a> 
							<a href="#" data-bind="click: $root.aceptar, attr: {id: 'saveProd' + $data.codigo()}" style="display:none;"><i class="icon-ok"></i></a>
						</td>
						<td data-bind="visible: faltante() > 0">
							Faltante: <span data-bind="text: faltante"></span>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
		</div>
		</div>
		<div class="span8 well" data-bind="visible: $root.mostrarForm">
		<div class="form-actions" style="text-align:right">			
			<button id="guardar" class="btn btn-primary" data-bind="click: $parent.generar">Guardar</button>
			<select id="generar" class="input-small" data-bind="visible: $root.editando(), value: tipo">
				<option value="1">Remito De Entrada</option>
				<option value="2">Orden De Trabajo</option>
				<option value="3">Remito De Salida</option>
				<option value="4">Ajuste</option>
				<option value="5">Recomposicion</option>
			</select>
			<button id="cancelar" class="btn" data-bind="click: $parent.cancelar">Cancelar</button>
		</div>
		</div>
	</div>
</div>
<script language="javascript">
	function lineaRemito() {
		var self = this;
		
		self.codigo = ko.observable();
		self.entrega = ko.observable();
		self.retira = ko.observable();
		self.faltante = ko.observable();
		self.descripcion = ko.observable();
		self.deposito = ko.observable();
	}
	
	function Remito() {
		var self = this;
		
		self.id = ko.observable(null);
		self.tipo = ko.observable("1");
		/*self.tipoRemito = ko.computed(function() {
			if(self.tipo()=="1") {
				return "Remito";
			} else if (self.tipo()=="2") {
				return "Orden de Trabajo";
			} else if (self.tipo()=="3") {
				return "Remito";
			}
		});*/
		self.deposito = ko.observable(null);
		self.empresa = ko.observable(null);
		self.persona = ko.observable(null);
		self.chofer = ko.observable(null);
		var nuevafecha = new Date();
		self.fecha = ko.observable(nuevafecha.getDate() + "/" + (nuevafecha.getMonth()+1) + "/" + nuevafecha.getFullYear());
		self.lineaRemitos = ko.observableArray();
		self.observaciones = ko.observable(null);
		self.horaEntrega = ko.observable(nuevafecha.getHours() + ":" + nuevafecha.getMinutes());
		self.horaRetiro = ko.observable(nuevafecha.getHours() + ":" + nuevafecha.getMinutes());
		self.vehiculo = ko.observable(null);
	}
	
	function RemitoModelo() {
		var self = this;
		
		self.title = ko.observable("Administrar Usuario");
		self.mostrarForm = ko.observable(true);
		self.mostrarSuccess = ko.observable(false);
		self.successMensaje = ko.observable("");
		self.mostrarError = ko.observable(false);
		self.errorMensaje = ko.observable("");
		self.mostrarFormError = ko.observable(false);
		self.formErrorMensaje = ko.observable("");
				
		self.nuevaLinea = ko.observable(new lineaRemito());
		self.codigos = ko.observableArray();
		self.codigoSeleccionado = ko.observable(null);
		self.empresas = ko.observableArray();
		self.choferes = ko.observableArray();
		self.vehiculos = ko.observableArray();
		
		self.remito = ko.validatedObservable(new Remito());
		self.editando = ko.observable(amplify.store.sessionStorage("sterilav.remitoEditado"));
		
		self.agregar = function() {
			var linea = new lineaRemito();
			linea.codigo(self.codigoSeleccionado().codigo);			
			linea.entrega($("#inputEntrega").val());			
			linea.retira($("#inputRetira").val());			
			linea.descripcion(self.codigoSeleccionado().descripcion);			
			linea.deposito(self.codigoSeleccionado().deposito);
			linea.faltante(self.codigoSeleccionado().faltante);
			self.remito().lineaRemitos.push(linea);
			self.codigos.remove(self.codigoSeleccionado());	
		};
		
		self.editar = function(prod) {
			$("#saveProd" + prod.codigo()).show();
			$("#editEntrega" + prod.codigo()).show();
			$("#showEntrega" + prod.codigo()).hide();
			$("#editRetira" + prod.codigo()).show();
			$("#showRetira" + prod.codigo()).hide();
			$("#delProd" + prod.codigo()).hide();
			$("#editProd" + prod.codigo()).hide();
		};
		
		self.borrar = function(prod) {
			self.remito().lineaRemitos.remove(prod);
			var produ = {};
			produ.codigo(prod.codigo());
			produ.entrega(prod.entrega());
			produ.retira(prod.retira());
			produ.descripcion(prod.descripcion());
			produ.deposito(prod.deposito());
			produ.faltante(prod.faltante());
			self.codigos.push(produ);
		};
						
		self.aceptar = function(prod) {
			var indexof = self.remito().lineaRemitos.indexOf(prod);
			console.log(prod);
			$("#saveProd" + prod.codigo()).hide();
			$("#editEntrega" + prod.codigo()).hide();
			$("#showEntrega" + prod.codigo()).show();
			$("#editRetira" + prod.codigo()).hide();
			$("#showRetira" + prod.codigo()).show();
			$("#delProd" + prod.codigo()).show();
			$("#editProd" + prod.codigo()).show();

			$("#showEntrega" + prod.codigo()).text(prod.entrega());
			$("#showRetira" + prod.codigo()).text(prod.retira());
		};
				
		self.volver = function() {
			window.location.href = "./Index.html";
		};
		
		self.cargaEmpresas = function() {
			var exitoEmpresa = function(empresas) {
				if(empresas.status != "OK") {
				} else {
					for(var i=0; i< empresas.data.length; i++) {
						var emp = new CEmpresa();
						emp.cargar(empresas.data[i]);
						emp.depositos = new Array();
						for(var j=0; j< empresas.data[i].depositos.length; j++) {
							var dep = new CDeposito();
							dep.cargar(empresas.data[i].depositos[j]);
							emp.depositos.push(dep);
						}
						self.empresas().push(emp);
					}
				}
				if(!amplify.store.sessionStorage("sterilav.remitoEditado")) {
					self.remito().empresa(self.empresas()[0]);
					self.remito().deposito(self.empresas()[0].depositos[0]);
				}
			};
			var fallaEmpresa = function(data) {
			};
			getDataSync("./servidor/sterilav.php?op=listaEmpresas",exitoEmpresa,fallaEmpresa);
		};
		self.cargaChoferes = function() {
			var exitoChofer = function(choferes) {
				if(choferes.status != "OK") {
				} else {
					for(var i=0; i< choferes.data.length; i++) {
						self.choferes().push(choferes.data[i]);
					}
				}
			};
			var fallaChofer = function(data) {
			};
			getDataSync("./servidor/sterilav.php?op=listaChoferes",exitoChofer,fallaChofer);
		};
		self.cargaVehiculos = function() {
			var exitoVehiculo = function(vehiculos) {
				if(vehiculos.status != "OK") {
				} else {
					for(var i=0; i< vehiculos.data.length; i++) {
						self.vehiculos().push(vehiculos.data[i]);
					}
				}
			};
			var fallaVehiculo = function(data) {
			};
			getDataSync("./servidor/sterilav.php?op=listaVehiculos",exitoVehiculo,fallaVehiculo);
		};
		self.cargaProductos = function() {
			var exitoProducto = function(productos) {
				if(productos.status != "OK") {
				} else {
					for(var i=0; i< productos.data.length; i++) {
						self.codigos().push(productos.data[i]);
					}
				}
			};
			var fallaProducto = function(data) {
			};
			getDataSync("./servidor/sterilav.php?op=listaProductosParaRemito",exitoProducto,fallaProducto);
		};
		self.cargaPersonas = function() {
			var exitoPersona = function(personas) {
				if(personas.status != "OK") {
				} else {
					self.remito().persona(new CUsuario());
					self.remito().persona().id(personas.data.id);
					self.remito().persona().usuario(personas.data.usuario);
					self.remito().persona().nombre(personas.data.nombre);
					self.remito().persona().apellido(personas.data.apellido);
					self.remito().persona().perfil(personas.data.perfil);
					self.remito().persona().password(personas.data.password);
					self.remito().persona().departamento(personas.data.departamento);
					self.remito().persona().remito(personas.data.remito);
					self.remito().persona().activo(personas.data.activo);
				}
			};
			var fallaPersona = function(data) {
			};
			getDataSync("./servidor/sterilav.php?op=getUsuarioPorNombre&nombre="+amplify.store.sessionStorage("sterilav.usuarioLogueado"),exitoPersona,fallaPersona);
		};
		
		self.generar = function() {
			console.log("Generando");
			self.remito().errors.showAllMessages(true);
			/*if (!self.remito().isValid()) {
				self.remito().showAllMessages();
				self.errorMensaje("Hay datos invalidos. Por favor controle el remito.");
				self.mostrarError(true);				
				return;
			}*/
			var exito = function(data) {
				if(data.status != "OK") {
					self.errorMensaje(data.data);
					self.mostrarError(true);				
				} else {
					self.mostrarForm(false);
					self.successMensaje("El Remito de Entrada se ha generado.");
					self.mostrarSuccess(true);
					amplify.store.sessionStorage("sterilav.remitoEditado", null);
				}
			};
			var falla = function(data) {
				if(data.data) {
					self.errorMensaje(data.data);
				} else {
					self.errorMensaje("Hubo un error tratando de generar el Remito.");
				}
				self.mostrarError(true);				
			};
			var url = "";
			if(amplify.store.sessionStorage("sterilav.remitoEditado")) {
				self.remito().id(amplify.store.sessionStorage("sterilav.remitoEditado"));
				url = "./servidor/sterilav.php?op=updateRemito";
			} else {
				url = "./servidor/sterilav.php?op=putRemito";
			}
			
			postData(url,exito,falla,JSON.parse(ko.toJSON(self.remito())));
		};
		self.cancelar = function() {
			amplify.store.sessionStorage("sterilav.remitoEditado", null);
			window.location.href = "./Index.html";
		};
		self.cargar = function() {
			var exito = function(data) {
				if(data.status != "OK") {
				} else {
					self.remito().deposito = ko.observable(new CDeposito());
					self.remito().empresa = ko.observable(new CEmpresa());
					self.remito().chofer = ko.observable(new CChofer());
					self.remito().vehiculo = ko.observable(new CVehiculo());
					self.remito().deposito().cargar(data.data.deposito);
					self.remito().empresa().cargar(data.data.empresa);
					self.remito().chofer().cargar(data.data.chofer);
					self.remito().vehiculo().cargar(data.data.vehiculo);
					var nuevafecha = new Date();
					self.remito().fecha((nuevafecha.getDate() + "/" + (nuevafecha.getMonth()+1) + "/" + nuevafecha.getFullYear()));
					for(i=0; i<data.data.productos.length;i++) {
						var linea = new lineaRemito();
						linea.codigo(data.data.productos[i].codigo);
						linea.descripcion(data.data.productos[i].descripcion);
						linea.deposito(data.data.productos[i].deposito);			
						linea.faltante(data.data.productos[i].faltante);			
						linea.retira(data.data.productos[i].retira);			
						linea.entrega(data.data.productos[i].entrega);			
						self.remito().lineaRemitos.push(linea);
					}
					self.remito().observaciones(data.data.observaciones);
				}
			};
			var falla = function(data) {
			};
			getData("./servidor/sterilav.php?op=getRemito&id=" + amplify.store.sessionStorage("sterilav.remitoEditado"),exito,falla);
		};
		
		if(amplify.store.sessionStorage("sterilav.remitoEditado")) {
			self.cargar();
			$("#guardar").text("Generar");
		} else {
			$("#guardar").text("Guardar");
		}
		self.cargaPersonas();
		self.cargaEmpresas();
		self.cargaProductos();
		self.cargaChoferes();
		self.cargaVehiculos();		
		var exitoprox = function(data) {
			if(data.status != "OK") {
			} else {
				self.remito().id(data.data.id);
			}
		};
		var fallaprox = function(data) {
			self.remito().id(-1);
		};
		getData("./servidor/sterilav.php?op=getProximoRemito",exitoprox,fallaprox);

		self.productos = ko.computed(function() {
 			return ko.utils.arrayFilter(self.codigos(), function(item) {
            	return item.deposito == self.remito().deposito().id();
        	});		
		}, this);		
	}

	var remitoModelo = new RemitoModelo();
	ko.applyBindings(remitoModelo, document.getElementById("remitoForm"));  
</script>