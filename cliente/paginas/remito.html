<div class="row span8" id="remitoForm" data-bind="with: remito">
	<div data-bind="visible: $root.mostrarSuccess" class="alert alert-success">
		<span data-bind="text: $root.successMensaje"></span>
	</div>
	<div data-bind="visible: $root.mostrarError" class="alert alert-error">
		<span data-bind="text: $root.errorMensaje"></span>
	</div>		
	<div data-bind="visible: $root.mostrarForm">
		<div class="span8 well">
			<h4>Remito</h4>
			<div class="row">
				<div class="control-group">
					<label class="control-label span2" for="selectEmpresa">Se&ntilde;or(es):</label>
					<select id="selectEmpresa" data-bind="options: $root.empresas, optionsText: 'razonSocial', value: empresa" class="input-large"></select>
					<select id="selectEmpresa" data-bind="options: empresa().depositos, optionsText: 'nombre', value: deposito" class="input-large"></select>
				</div>		
			</div>
			<div class="row">
				<label class="control-label span2" for="inputApellido">Domicilio:</label>
				<span class="span5" id="inputApellido" data-bind="text: deposito().domicilio"></span>
			</div>
			<div class="row">
				<label class="control-label span2" for="inputCalle">Departamento:</label>
				<span class="span2" id="inputCalle" data-bind="text: deposito().departamento"></span>
				<label class="control-label span2" for="inputCUIT">N&uacute;mero de CUIT :</label>
				<span class="span2" id="inputCUIT" data-bind="text: empresa().cuit"></span>
			</div>
			<div class="row">
				<label class="control-label span2" for="inputIVA">Condici&oacute;n de IVA:</label>
				<span class="span5" id="inputIVA" data-bind="">{IVA Responsable}</span>
			</div>
		</div>
		<div class="span8 well form-inline">
			<label class="control-label" for="inputTipo">Condici&oacute;n de Venta:</label>
			<span id="inputTipo" data-bind="">Contado</span>
			<label class="control-label" for="inputTipo">Factura N&uacute;mero:</label>
			<span id="inputTipo" data-bind="">0001-12345678</span>
		</div>
		<div class="span8 well">
			<form id="login-form" class="form-inline">
				<legend>Remito</legend>
				<fieldset>
					<label class="control-label" for="inputTipo">C&oacute;digo:</label>
					<select type="text" id="inputCodigo" data-bind="options: $parent.codigos, optionsText: 'id', value: $parent.codigoSeleccionado" class="input-large" style="width:150px;">
					</select>
					<input type="text" id="inputCantidad" class="input-large" style="width:150px;">
					<input type="text" id="inputDescripcion" data-bind="value: $parent.codigoSeleccionado() ? $parent.codigoSeleccionado().descripcion : ''" class="input-large" style="width:250px;" disabled>
					<button id="registro" class="btn btn-primary" data-bind="click: $parent.agregar">Agregar</button>
				</fieldset>
			</form>
			<table class="table table-striped table-bordered">
				<thead>
					<tr>
						<th>Codigo</th><th>Cantidad</th><th>Descripcion</th>
					</tr>
				</thead>
				<tbody data-bind="foreach: lineaRemitos">
					<tr>
						<td data-bind="text: codigo"></td>
						<td data-bind="text: cantidad"></td>
						<td data-bind="text: descripcion"></td>
					</tr>
				</tbody>
			</table>
			<button id="generar" class="btn btn-primary" data-bind="click: $parent.generar">Generar</button>
		</div>
	</div>
</div>
<script language="javascript">
	function lineaRemito() {
		var self = this;
		
		self.codigo = ko.observable();
		self.cantidad = ko.observable();
		self.descripcion = ko.observable();
	}
	
	function Remito() {
		var self = this;
		
		self.deposito = ko.observable(null);
		self.empresa = ko.observable(null);
		self.fecha = ko.observable(new Date());
		self.lineaRemitos = ko.observableArray();
	}
	
	function RemitoModelo() {
		var self = this;
		
		self.title = ko.observable("Administrar Usuario");
		self.mostrarForm = ko.observable(true);
		self.mostrarSuccess = ko.observable(false);
		self.successMensaje = ko.observable("");
		self.mostrarError = ko.observable(false);
		self.errorMensaje = ko.observable("");
		self.mostrarFormError = ko.observable(false);
		self.formErrorMensaje = ko.observable("");
				
		self.nuevaLinea = ko.observable(new lineaRemito());
		self.codigos = ko.observableArray();
		self.codigoSeleccionado = ko.observable(null);
		self.empresas = ko.observableArray();
		self.remito = ko.validatedObservable(new Remito());
		
		self.agregar = function() {
			var linea = new lineaRemito();
			linea.codigo(self.codigoSeleccionado().id);			
			linea.cantidad($("#inputCantidad").val());			
			linea.descripcion(self.codigoSeleccionado().descripcion);			
			self.remito().lineaRemitos.push(linea);
		};
		
		self.volver = function() {
			window.location.href = "./Index.html";
		};
		
		self.cargaEmpresas = function() {
			var exitoEmpresa = function(empresas) {
				if(empresas.status != "OK") {
				} else {
					for(var i=0; i< empresas.data.length; i++) {
						self.empresas().push(empresas.data[i]);
					}
				}
			};
			var fallaEmpresa = function(data) {
			};
			getDataSync("./servidor/sterilav.php?op=listaEmpresas",exitoEmpresa,fallaEmpresa);
			/*for(var i=0; i< 10; i++) {
				self.empresas().push({id:i, descripcion:"empresa "+i});
			}*/
		};
		self.cargaProductos = function() {
			var exitoProducto = function(productos) {
				if(productos.status != "OK") {
				} else {
					for(var i=0; i< productos.data.length; i++) {
						self.codigos().push({id:productos.data[i].id, descripcion:productos.data[i].descripcion});
					}
				}
			};
			var fallaProducto = function(data) {
			};
			getDataSync("./servidor/sterilav.php?op=listaProductos",exitoProducto,fallaProducto);
			/*for(var i=0; i< 10; i++) {
				self.codigos().push({id:i, descripcion:"producto "+i});
			}*/		
		};
		
		self.generar = function() {
			self.remito().errors.showAllMessages(true);
			if (!self.remito().isValid()) {
				return;
			}
			//Guardar en la base de datos
			//self.mostrarFormError(false);
			var exito = function(data) {
				if(data.status != "OK") {
					$("#errorMsg").show();
					$("#errorMsg").append(data.data);
				} else {
					self.mostrarForm(false);
					self.successMensaje("El remito se ha generado.");
					self.mostrarSuccess(true);
					amplify.store.sessionStorage("sterilav.remitoEditado", null);
				}
			};
			var falla = function(data) {
				if(data.data) {
					self.formErrorMensaje(data.data);
				} else {
					self.formErrorMensaje("Hubo un error tratando de generar el remito.");
				}
				self.mostrarFormError(true);				
			};
			var url = "";
			if(amplify.store.sessionStorage("sterilav.remitoEditado")) {
				url = "./servidor/sterilav.php?op=updateRemito";
			} else {
				url = "./servidor/sterilav.php?op=putRemito";
			}
			postData(url,exito,falla,JSON.parse(ko.toJSON(self.remito())));
		};
		
		self.cargaEmpresas();
		self.cargaProductos();
	}

	var remitoModelo = new RemitoModelo();
	ko.applyBindings(remitoModelo, document.getElementById("remitoForm"));  
</script>
